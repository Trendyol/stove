# <span data-rn="underline" data-rn-color="#ff9800">0.21.0</span>

**Released:** February 2026

This release introduces:

<ul data-rn-group>
<li><strong>Tracing</strong>: See the <span data-rn="highlight" data-rn-color="#00968855">full execution trace</span> of your application when a test fails: every controller, database query, Kafka message, and HTTP call with timing and failure points</li>
<li><strong>gRPC Mocking</strong>: <span data-rn="underline" data-rn-color="#009688">Mock external gRPC services in your tests with a type-safe DSL</span></li>
<li><strong>MySQL Support</strong>: <span data-rn="underline" data-rn-color="#ff9800">New <code>stove-mysql</code> module</span> for testing against MySQL databases</li>
<li><strong>WireMock Test Scoping</strong>: WireMock snapshots are now scoped to the current test for cleaner failure reports</li>
<li><strong>Dynamic Port Allocation</strong>: WireMock now defaults to <code>port = 0</code> and gRPC Mock supports it, no more port conflicts in CI</li>
<li><strong>Migration Type Aliases</strong>: <code>PostgresqlMigration</code>, <code>MongodbMigration</code>, etc. instead of verbose <code>DatabaseMigration&lt;XyzContext&gt;</code></li>
<li><strong>Elasticsearch 9 Support</strong>: Adapted to work with Elasticsearch 9.x</li>
<li><strong>Spring Showcase Recipe</strong>: A comprehensive example project demonstrating all Stove features together</li>
</ul>

---

## New Features

### Tracing

When a test fails, you no longer have to guess what happened inside your application. Stove captures the <span data-rn="highlight" data-rn-color="#00968855" data-rn-duration="800">entire call chain</span>: every controller method, database query, Kafka message, and HTTP call, and displays it as a trace tree in the failure report:

```
═══════════════════════════════════════════════════════════════════════════════
EXECUTION TRACE (Call Chain)
═══════════════════════════════════════════════════════════════════════════════
✓ POST (377ms)
  ✓ POST /api/product/create (361ms)
    ✓ ProductController.create (141ms)
      ✓ ProductCreator.create (0ms)
      ✓ KafkaProducer.send (137ms)
        ✓ orders.created publish (81ms)
          ✗ orders.created process (82ms)  ← FAILURE POINT
```

Setup takes two steps:

1. Enable in your Stove config:

```kotlin hl_lines="3-4"
Stove()
    .with {
        tracing {
            enableSpanReceiver()
        }
    }
```

2. Attach the OpenTelemetry agent in `build.gradle.kts`:

```kotlin hl_lines="3-4"
import com.trendyol.stove.gradle.configureStoveTracing

configureStoveTracing {
    serviceName = "my-service"
}
```

<span data-rn="highlight" data-rn-color="#4caf5044" data-rn-duration="800">Everything else is automatic.</span> Trace headers are injected into HTTP, Kafka, and gRPC calls, spans are collected and correlated, and failure reports are enriched with the trace tree.

A validation DSL is also available for asserting on the execution flow:

```kotlin hl_lines="2 3 4"
tracing {
    shouldContainSpan("OrderService.processOrder")
    shouldNotHaveFailedSpans()
    executionTimeShouldBeLessThan(500.milliseconds)
}
```

See the [Tracing documentation](../Components/15-tracing.md) for full details.

---

### gRPC Mocking

New `stove-grpc-mock` module for mocking external gRPC services in your tests. This lets you test gRPC client code without running the actual upstream services.

```kotlin
dependencies {
    testImplementation("com.trendyol:stove-grpc-mock:$stoveVersion")
}
```

Configure in your Stove setup:

```kotlin hl_lines="2"
grpcMock {
    GrpcMockSystemOptions(port = 0) // Dynamic port allocation
}
```

Stub responses with a type-safe DSL:

```kotlin hl_lines="2-3"
grpcMock {
    mockUnary(
        FraudDetectionServiceGrpc.getCheckFraudMethod(),
        response = FraudCheckResponse.newBuilder()
            .setIsFraud(false)
            .setScore(0.1)
            .build()
    )
}
```

Supports unary, server streaming, and conditional matching. See the [gRPC Mocking documentation](../Components/14-grpc-mock.md) for full details.

---

### MySQL Support

New `stove-mysql` module with the same familiar DSL as PostgreSQL and MSSQL:

```kotlin
dependencies {
    testImplementation("com.trendyol:stove-mysql:$stoveVersion")
}
```

```kotlin
Stove()
    .with {
        mysql {
            MysqlOptions(
                databaseName = "mydb",
                configureExposedConfiguration = { cfg ->
                    listOf(
                        "spring.datasource.url=${cfg.jdbcUrl}",
                        "spring.datasource.username=${cfg.username}",
                        "spring.datasource.password=${cfg.password}"
                    )
                }
            )
        }
    }
```

Supports migrations, `shouldQuery`, `shouldExecute`, and all the database operations you'd expect. See the [MySQL documentation](../Components/16-mysql.md) for details.

---

### WireMock Test Scoping

WireMock snapshots in failure reports are <span data-rn="underline" data-rn-color="#009688">now scoped to the current test</span>. Previously, all registered stubs and requests across the entire test suite would appear in the snapshot. Now you only see stubs and requests relevant to the test that failed, making failure reports much easier to read.

---

### Dynamic Port Allocation

Both WireMock and gRPC Mock now support dynamic port allocation with `port = 0`, which prevents port conflicts when running tests in parallel on CI.

**WireMock** now defaults to `port = 0`. You no longer need to pick a port:

```kotlin
wiremock {
    WireMockSystemOptions(
        configureExposedConfiguration = { cfg ->
            listOf("external-apis.inventory.url=${cfg.baseUrl}")
        }
    )
}
```

**gRPC Mock** also supports `port = 0`:

```kotlin
grpcMock {
    GrpcMockSystemOptions(port = 0)
}
```

In both cases, the actual port is exposed via `configureExposedConfiguration` so your application receives the correct URL.

---

### Spring Showcase Recipe

A new comprehensive recipe at `recipes/kotlin-recipes/spring-showcase/` demonstrates all Stove features working together in a realistic Spring Boot application:

- HTTP endpoints with PostgreSQL
- Kafka producers and consumers
- gRPC server and client with mocked upstream
- WireMock for external HTTP APIs
- Tracing
- Database migrations
- db-scheduler integration

<span data-rn="highlight" data-rn-color="#4caf5044" data-rn-duration="800">This is the best starting point for understanding how Stove fits into a real project.</span>

---

### Migration Type Aliases

Each module that supports migrations now provides a convenient type alias, so you no longer need to remember `DatabaseMigration<PostgresSqlMigrationContext>` and similar verbose signatures:

```kotlin
// Before
class CreateUsersTable : DatabaseMigration<PostgresSqlMigrationContext> { ... }

// After
class CreateUsersTable : PostgresqlMigration { ... }
```

Available aliases:

| Module              | Type Alias               |
|---------------------|--------------------------|
| stove-postgres      | `PostgresqlMigration`    |
| stove-mysql         | `MySqlMigration`         |
| stove-mssql         | `MsSqlMigration`         |
| stove-mongodb       | `MongodbMigration`       |
| stove-couchbase     | `CouchbaseMigration`     |
| stove-elasticsearch | `ElasticsearchMigration` |
| stove-redis         | `RedisMigration`         |
| stove-kafka         | `KafkaMigration`         |

The generic `DatabaseMigration<T>` interface remains fully supported. The aliases are purely additive.

---

## Improvements

### Elasticsearch 9 Support

`stove-elasticsearch` now works with Elasticsearch 9.x (specifically 9.3.0). The module adapts to the updated client API automatically.

### Improved Failure Reports

- Exception details (type, message, stack trace) are now extracted from OpenTelemetry spans and displayed in trace trees
- Console renderer output is cleaner and better formatted
- Kafka report entries now include all relevant state

### Tracing Configuration Cache Compatibility

The `configureStoveTracing` Gradle helper is now fully compatible with Gradle configuration cache, so builds with `--configuration-cache` work correctly.

### Non-ASCII Test ID Support

Trace context test IDs now handle non-ASCII characters (e.g., Japanese, Korean) correctly by normalizing to ASCII with hash suffixes for uniqueness. This ensures consistent behavior when test names use non-Latin scripts.

### BridgeSystem Suspended

`BridgeSystem` methods are now `suspend` functions, allowing proper coroutine support in bridge implementations.

---

## Bug Fixes

- **HTTP streaming**: Fixed a flow collection issue that could cause streaming responses to hang
- **Kafka tests**: Fixed flaky test behavior in Kafka system tests
- **Tracing configuration cache**: Fixed serialization issues when using Gradle configuration cache with `configureStoveTracing`
- **ASCII character handling**: Fixed edge cases in test ID sanitization for non-ASCII characters

---

## Dependency Updates

- Elasticsearch 9.3.0
- Kafka (Confluent) 8.1.1
- Confluent Platform Kafka 8.0.3
- gRPC Java 1.79.0
- Protobuf 4.33.5
- OpenTelemetry 1.59.0
- Kotlin (latest patch)
- Ktor 3.4.0
- Flyway 12.x
- HikariCP 7.x
- Various Spring, Quarkus, and Micronaut updates

---

## Migration Guide

### From 0.20.x to 0.21.0

This is a <span data-rn="highlight" data-rn-color="#4caf5044" data-rn-duration="800">non-breaking</span> release. All existing APIs remain compatible.

#### New Features to Opt Into

**Tracing**: Add `stove-tracing` to your dependencies and follow the [setup guide](../Components/15-tracing.md).

**gRPC Mocking**: Add `stove-grpc-mock` to your dependencies if you need to mock external gRPC services. See the [gRPC Mocking documentation](../Components/14-grpc-mock.md).

**MySQL**: Add `stove-mysql` if you're testing against MySQL. See the [MySQL documentation](../Components/16-mysql.md).

#### Recommended Updates

- If using Elasticsearch, verify compatibility with Elasticsearch 9.x
- If using `configureStoveTracing`, no changes needed. Configuration cache compatibility is automatic
- Consider switching `GrpcMockSystemOptions` to `port = 0` for CI-friendly dynamic port allocation

---

## Getting Started

```kotlin hl_lines="2 4 5 6 7"
dependencies {
    testImplementation(platform("com.trendyol:stove-bom:0.21.0"))

    testImplementation("com.trendyol:stove")
    testImplementation("com.trendyol:stove-spring")
    testImplementation("com.trendyol:stove-tracing")
    testImplementation("com.trendyol:stove-extensions-kotest")
    // Add components as needed
}
```

For snapshot versions:

```kotlin hl_lines="2"
repositories {
    maven("https://central.sonatype.com/repository/maven-snapshots")
}
```
