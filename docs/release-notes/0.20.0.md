# 0.20.0 (To be released)

**Release Date:** To be released

This release introduces:

- **Spring Boot 4.x Support**: Full support for Spring Boot 4.x and Spring Kafka 4.x
- **Unified Spring Modules**: Single modules that work across Spring Boot 2.x, 3.x, and 4.x
- **New Bean Registration DSL**: `stoveSpring4xRegistrar` for Spring Boot 4.x (since `BeanDefinitionDsl` is deprecated)
- **Runtime Version Checks**: Clear error messages when Spring Boot/Kafka is missing from classpath

---

## New Features

### Spring Boot 4.x Support

Stove now fully supports Spring Boot 4.x and Spring Kafka 4.x. The existing `stove-spring-testing-e2e` and `stove-spring-testing-e2e-kafka` modules work with all Spring Boot versions (2.x, 3.x, and 4.x).

**Dependencies remain the same:**

```kotlin
testImplementation("com.trendyol:stove-spring-testing-e2e:0.20.0")
testImplementation("com.trendyol:stove-spring-testing-e2e-kafka:0.20.0")
```

---

### New Bean Registration DSL for Spring Boot 4.x

Spring Boot 4.x deprecates `BeanDefinitionDsl` (`beans { }` DSL). Stove provides new extension functions for cleaner bean registration:

**Spring Boot 2.x / 3.x - use `addTestDependencies`:**

```kotlin
import com.trendyol.stove.testing.e2e.addTestDependencies

springBoot(
    runner = { params ->
        runApplication<MyApp>(args = params) {
            addTestDependencies {
                bean<TestSystemKafkaInterceptor<*, *>>()
                bean<MyService> { MyServiceImpl() }
            }
        }
    }
)
```

**Spring Boot 4.x - use `addTestDependencies4x`:**

```kotlin
import com.trendyol.stove.testing.e2e.addTestDependencies4x

springBoot(
    runner = { params ->
        runApplication<MyApp>(args = params) {
            addTestDependencies4x {
                registerBean<TestSystemKafkaInterceptor<*, *>>(primary = true)
                registerBean<MyService> { MyServiceImpl() }
            }
        }
    }
)
```

**Alternative: Using `addInitializers` directly:**

```kotlin
// Spring Boot 2.x / 3.x
addInitializers(stoveSpringRegistrar { bean<MyService>() })

// Spring Boot 4.x
addInitializers(stoveSpring4xRegistrar { registerBean<MyService>() })
```

**Key differences for 4.x:**
- Use `registerBean<T>()` instead of `bean<T>()`
- Use `registerBean<T>(primary = true)` for primary beans
- No `ref()` function - use constructor injection instead

---

### Runtime Version Checks

When Spring Boot or Spring Kafka is missing from the classpath, Stove now provides clear error messages:

```
═══════════════════════════════════════════════════════════════════════════════
  Spring Boot Not Found on Classpath!
═══════════════════════════════════════════════════════════════════════════════

  stove-spring-testing-e2e requires Spring Boot to be on your classpath.
  Spring Boot is declared as a 'compileOnly' dependency, so you must add it
  to your project.

  Add one of the following to your build.gradle.kts:

  For Spring Boot 2.x:
    testImplementation("org.springframework.boot:spring-boot-starter:2.7.x")

  For Spring Boot 3.x:
    testImplementation("org.springframework.boot:spring-boot-starter:3.x.x")

  For Spring Boot 4.x:
    testImplementation("org.springframework.boot:spring-boot-starter:4.x.x")

═══════════════════════════════════════════════════════════════════════════════
```

---

## Migration Guide

### From 0.19.x

#### For Spring Boot 2.x and 3.x Users

**If using `BaseApplicationContextInitializer`:** Migrate to `addTestDependencies` (see Breaking Changes above).

**If using `beans { }` directly:** Your existing code continues to work. Optionally, use the new cleaner API:

```kotlin
// Old way (still works)
addInitializers(beans { bean<MyService>() })

// New way (recommended)
addTestDependencies { bean<MyService>() }
```

#### For Spring Boot 4.x Users (New!)

Spring Boot 4.x is newly supported in this release. Use `addTestDependencies4x`:

```kotlin
import com.trendyol.stove.testing.e2e.addTestDependencies4x

springBoot(
    runner = { params ->
        runApplication<MyApp>(args = params) {
            addTestDependencies4x {
                registerBean<TestSystemKafkaInterceptor<*, *>>(primary = true)
                registerBean<MyService> { MyServiceImpl() }
            }
        }
    }
)
```

Note: The `beans { }` DSL from Spring is deprecated in 4.x, which is why Stove provides `addTestDependencies4x` with `registerBean<T>()`.

---

### Breaking Changes

#### `BaseApplicationContextInitializer` Removed

`BaseApplicationContextInitializer` has been removed. Migrate to `addTestDependencies`:

**Before (0.19.0):**

```kotlin
class TestSystemInitializer : BaseApplicationContextInitializer({
    bean<TestSystemKafkaInterceptor<*, *>>()
    bean<MyService> { MyServiceImpl() }
})

// Usage
runApplication<MyApp>(args = params) {
    addInitializers(TestSystemInitializer())
}
```

**After (0.20.0):**

```kotlin
import com.trendyol.stove.testing.e2e.addTestDependencies

runApplication<MyApp>(args = params) {
    addTestDependencies {
        bean<TestSystemKafkaInterceptor<*, *>>()
        bean<MyService> { MyServiceImpl() }
    }
}
```

This is simpler - no need to create a separate class.

---

### Notes

#### Dead Letter Topic Naming Convention (Spring Kafka)

Be aware that Spring Kafka changed the default DLT (Dead Letter Topic) naming convention between versions:

| Spring Kafka Version | DLT Suffix | Example |
|---------------------|------------|---------|
| 2.x | `.DLT` | `my-topic.DLT` |
| 3.x, 4.x | `-dlt` | `my-topic-dlt` |

This is not a Stove change, but something to be aware of when writing Kafka tests across different Spring Kafka versions.

---

## Dependency Updates

- Spring Boot 4.x support (4.0.0+)
- Spring Kafka 4.x support (4.0.0+)
- Continued support for Spring Boot 2.7.x and 3.x
- Continued support for Spring Kafka 2.9.x and 3.x

---

## Full Changelog

See the [GitHub Releases](https://github.com/Trendyol/stove/releases) page for the complete list of commits and contributors.

---

## Contributors

Thanks to all contributors who made this release possible!

---

## Getting Started

```kotlin
dependencies {
    testImplementation("com.trendyol:stove-testing-e2e:0.20.0")
    testImplementation("com.trendyol:stove-spring-testing-e2e:0.20.0")
    // Add component-specific dependencies as needed
    testImplementation("com.trendyol:stove-spring-testing-e2e-kafka:0.20.0")
}
```

For snapshot versions, add the snapshot repository:

```kotlin
repositories {
    maven("https://central.sonatype.com/repository/maven-snapshots")
}
```
