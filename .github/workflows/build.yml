name: Build
on:
  push:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'lib/**'
      - 'starters/**'
      - 'gradle/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'buildSrc/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'lib/**'
      - 'starters/**'
      - 'gradle/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'buildSrc/**'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  # Testcontainers optimization settings
  TESTCONTAINERS_RYUK_DISABLED: false
  DOCKER_BUILDKIT: 1

jobs:
  # Fast checks that don't need containers - runs in parallel with setup
  quick-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6

      - name: Configure JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: current

      - name: Run quick checks (compile, spotless, detekt)
        run: gradle --build-cache --configuration-cache classes testClasses spotlessCheck detekt apiCheck

  # Matrix-based parallel test execution
  test:
    needs: quick-checks
    runs-on: ubuntu-latest
    permissions:
      checks: write
      id-token: write
      issues: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - name: "core-and-http"
            projects: ":lib:stove-testing-e2e:test :lib:stove-testing-e2e-http:test :lib:stove-testing-e2e-wiremock:test"
            images: ""
          - name: "kafka"
            projects: ":lib:stove-testing-e2e-kafka:test :starters:spring:stove-spring-testing-e2e-kafka:test"
            images: "confluentinc/cp-kafka"
          - name: "databases"
            projects: ":lib:stove-testing-e2e-rdbms-postgres:test :lib:stove-testing-e2e-rdbms-mssql:test :lib:stove-testing-e2e-mongodb:test"
            images: "postgres mongo mcr.microsoft.com/mssql/server"
          - name: "nosql"
            projects: ":lib:stove-testing-e2e-couchbase:test :lib:stove-testing-e2e-elasticsearch:test :lib:stove-testing-e2e-redis:test"
            images: "couchbase/server elasticsearch redis"
          - name: "starters"
            projects: ":starters:spring:stove-spring-testing-e2e:test :starters:ktor:stove-ktor-testing-e2e:test :starters:micronaut:stove-micronaut-testing-e2e:test"
            images: ""
          # Examples split into separate jobs to avoid WireMock port conflicts
          - name: "example-spring"
            projects: ":examples:spring-example:test"
            images: ""
          - name: "example-spring-standalone"
            projects: ":examples:spring-standalone-example:test"
            images: ""
          - name: "example-spring-streams"
            projects: ":examples:spring-streams-example:test"
            images: ""
          - name: "example-ktor"
            projects: ":examples:ktor-example:test"
            images: ""
          - name: "example-micronaut"
            projects: ":examples:micronaut-example:test"
            images: ""
    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6

      - name: Configure JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: current

      # Pre-pull Docker images in parallel to speed up tests
      - name: Pre-pull Docker images
        if: matrix.test-group.images != ''
        run: |
          echo "Pre-pulling images: ${{ matrix.test-group.images }}"
          for image in ${{ matrix.test-group.images }}; do
            docker pull $image &
          done
          wait
        continue-on-error: true

      - name: Run tests - ${{ matrix.test-group.name }}
        run: |
          gradle --build-cache --configuration-cache \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.workers.max=4 \
            ${{ matrix.test-group.projects }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-group.name }}
          path: |
            **/build/test-results/test/
            **/build/reports/tests/
          retention-days: 7

  # Aggregate coverage after all tests pass
  coverage:
    needs: test
    runs-on: ubuntu-latest
    if: github.repository == 'Trendyol/stove'
    permissions:
      checks: write
      id-token: write
      issues: write
      pull-requests: write
    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6

      - name: Configure JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: current

      - name: Generate coverage report
        run: gradle --build-cache --configuration-cache koverXmlReport

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
