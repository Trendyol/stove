name: Build Recipes
on:
  push:
    branches: [ main ]
    paths:
      - 'recipes/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'recipes/**'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  TESTCONTAINERS_RYUK_DISABLED: false
  DOCKER_BUILDKIT: 1

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: Configure JDK
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Check out Git repository
        uses: actions/checkout@v6

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: current

      - name: Gradle Build and Test
        run: |
          gradle -p recipes --build-cache \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.workers.max=4 \
            build test e2eTest
